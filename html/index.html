<!DOCTYPE html>

<html>
<head>

	<script src="https://www.gstatic.com/firebasejs/4.5.2/firebase.js">
		
	</script>

	<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-app.js"></script>

	<script src="https://www.gstatic.com/firebasejs/4.5.0/firebase-database.js"></script>
  <link href="../css/style.css" rel="stylesheet">
  <script>
  // Initialize Firebase
  var config = {
  	apiKey: "AIzaSyADnVGr84Qq2qeRz5vc2bZ3MQbjJ6GKSOU",
  	authDomain: "cchs-carpool.firebaseapp.com",
  	databaseURL: "https://cchs-carpool.firebaseio.com",
  	projectId: "cchs-carpool",
  	storageBucket: "cchs-carpool.appspot.com",
  	messagingSenderId: "136028210350"
  };
  firebase.initializeApp(config);
</script>

</head>


<body>
  <input type='text' id='name' placeholder='name'>
  <input type='text' id='address' placeholder='address'>
  <input type='text' id='town' placeholder='town'>
  <input type='text' id='state' placeholder='state'>
  <input type='text' id='zipcode' placeholder='zipcode'>
  <button type='button' id = "addaddress" onclick="addUser()">Add Marker</button> 

</br>

<!-- Google maps element dom -->
<div id="map"></div>

<!-- GOOGLE MAPS CODE BELOW -->
<!-- FIREBASE CODE BELOW -->

<script>

  function initFirebase(){

    var database = firebase.database(); 
  }
  function addUser(){
    var name = document.getElementById('name').value; 
    console.log(name); 
    var address = document.getElementById('address').value; 
    var town = document.getElementById('town').value; 
    var zipcode = document.getElementById('zipcode').value; 
    var state = document.getElementById('state').value; 

    firebase.database().ref('Students/' + name).set({
      "address": address, 
      "town": town, 
      "zipcode": zipcode, 
      "state": state

    });
    console.log("added"); 

  }
  initFirebase(); 
</script>
<script>
  var studentsRef = firebase.database().ref('Students'); 
  function initMap() {
    var uluru = {lat: 42.539278, lng: -71.366407};

    var map = new google.maps.Map(document.getElementById('map'), {
      zoom: 12,
      center: uluru
    });
    var geocoder = new google.maps.Geocoder;
    var infowindow = new google.maps.InfoWindow;

    var marker = new google.maps.Marker({
      position: uluru,
      map: map
    });

    
    

    
    studentsRef.once("value")
    .then(function(snapshot) {
      snapshot.forEach(function(childSnapshot) {
          var key = childSnapshot.key;
          console.log(key); 
          var val = childSnapshot.val(); 

          var address = val["address"] + " " + val["town"] + " " + val["state"] + " " + val["zipcode"];
          console.log(val["address"]); 
          geocodeAddress(geocoder, map, infowindow, address);

           
      });

      
    });


    studentsRef.on("child_added", function(snapshot, prevChildKey) {
      console.log("student added"); 
      var key = snapshot.key; 
      var val = snapshot.val(); 
      var address = val["address"] + " " + val["town"] + " " + val["state"] + " " + val["zipcode"];
          
          geocodeAddress(geocoder, map, infowindow, address);
    });

    

    

    document.getElementById('addaddress').addEventListener('click', function() {
      // var address = document.getElementById('address').value + " " + document.getElementById('town').value + " " + document.getElementById('state').value + " " + document.getElementById('zipcode').value;
      // geocodeAddress(geocoder, map, infowindow, address);
      addUser(); 
    });
  }

  function geocodeAddress (geocoder, map, infowindow, address) {
    

    geocoder.geocode( { 'address': address}, function(results, status) {
      if (status == 'OK') {
        map.setCenter(results[0].geometry.location);
        var marker = new google.maps.Marker({
          map: map,
          position: results[0].geometry.location
        });
      } else {
        alert('Geocode was not successful for the following reason: ' + status);
      }
    });
  }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBDNGE0_gOFq0YbFjSB9OxtdwBcHSRm5_s&callback=initMap" async defer></script>

</body>



</html>